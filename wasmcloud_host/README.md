# `wasmcloud_host`

## Prerequisites

1. Install the latest versions of Rust and Go

1. Since the build of `wasmcloud-otp` will fail on version `16.xx.yy` of NodeJs, you should either install, or switch to, version `14.xx.yy` of NodeJS.

    Typically, a NodeJS version management tool such as `nvm` or `fnm` is used:

    E.G. To install Fast Node Manager (`fnm`):

    ```console
    $ cargo install fvm
    ```

    Install the latest version of NodeJS version 14

    ```console
    $ fnm install 14
    Installing Node v14.17.6
    ```

    Make NodeJS version 14 the default

    ```console
    $ fnm use 14
    Using Node v14.17.6
    ```

1. Clone the repo `wasmCloud/wasmcloud-otp` into some suitable development directory

    ```console
    $ git clone https://github.com/wasmCloud/wasmcloud-otp.git
    ```

1. Install and start `nats-server` using the JetStream option

    ```console
    $ brew install nats-server
    $ nats-server -js
    ```

This terminal window is now occupied with the `nats-server` console logs

## Local Server Build

In a new terminal, change into the `wasmcloud-otp` folder, then change into the `assets` folder underneath `wasmcloud_host`

1. `cd wasmCloud/wasmcloud-otp/wasmcloud_host`

1. Run `npm install`.  As long as you have switched to version `14.xx.yy` of NodeJs, this should run successfully

1. Change up one directory level and run `make run-interactive`.  This will build the wasmcloud server and connect it to your already-started NATS server

1. This terminal window now shows both an Elixir command prompt and from time to time, any wasmcloud console logs

1. You can now point your browser to (localhost:4000)[localhost:4000] to see the wasmcloud dashboard

## Building Capability Providers

In the `capability_providers` folder, there are two simple capability providers: `httpserver` and `keyvalue`

Both providers must be built using the supplied `Makefile`, so first change into the `capability_providers` directory

### Building `httpserver`

The `httpserver` provider has been written in Go and can be built using the command:

```console
$ make httpserver-<os>
```

Where `<os>` is either `linux`, `mac` or `windows`

E.G. To build the Mac `httpserver` provider

```console
$ make httpserver-mac
mkdir -p ./_build
cd httpserver/go && \
        GOOS=darwin go build -o httpserver-mac && \
        mv httpserver-mac ../../_build/httpserver-mac
```

## Building `keyvalue`

The `keyvalue` provider has been written in Rust and ***not*** is built not using `cargo`!

Due to the fact that different compilation targets can be generated by the same `Makefile`, the Rust cross compiler `cross` is used instead of `cargo`.

1. Install (or update) `cross`

    ```console
    $ cargo install cross
    Updating crates.io index
      Downloaded cross v0.2.1
      Downloaded 1 crate (175.1 KB) in 0.27s
      Installing cross v0.2.1
      Downloaded cc v1.0.70
      Downloaded which v3.1.1

      <snip>

      Downloaded libc v0.2.101
      Downloaded 12 crates (1.2 MB) in 0.48s
       Compiling libc v0.2.101

      <snip>

      Compiling toml v0.5.8
       Finished release [optimized] target(s) in 40.28s
     Installing /Users/chris/.cargo/bin/cross
      Installed package `cross v0.2.1` (executable `cross`)
    ```

1. Make sure that `cross` is used instead of `cargo`

    ```console
    $ export CARGO=CROSS
    ```

1. Create the `keyvalue` provider

    ```console
    $ make keyvalue-mac
    mkdir -p ./_build
    cd keyvalue/rust && \
            CROSS build --release --target x86_64-apple-darwin && \
            cp target/x86_64-apple-darwin/release/wasmcloud-redis ../../_build/wasmcloud-redis-mac
    warning: unused import: `Read`
      --> src/main.rs:21:30
       |
    21 | use std::io::{self, BufRead, Read};
       |                              ^^^^
       |
       = note: `#[warn(unused_imports)]` on by default

    warning: 1 warning emitted

    Finished release [optimized] target(s) in 1.01s
    ```

1. If you wish to build `keyvalue` for some other target system, you should first identify the target name:

    ```console
    $ rustup target list

    <snip>

    wasm32-unknown-emscripten
    wasm32-unknown-unknown (installed)
    wasm32-wasi (installed)
    x86_64-apple-darwin (installed)
    x86_64-apple-ios
    x86_64-fortanix-unknown-sgx
    x86_64-fuchsia
    x86_64-linux-android
    x86_64-pc-solaris
    x86_64-pc-windows-gnu
    x86_64-pc-windows-msvc
    x86_64-sun-solaris
    x86_64-unknown-freebsd
    x86_64-unknown-illumos
    x86_64-unknown-linux-gnu (installed)
    x86_64-unknown-linux-gnux32
    x86_64-unknown-linux-musl
    x86_64-unknown-netbsd
    x86_64-unknown-redox
    ```

    Using the command `rustup install target <target_name>`, install the required Rust compilation target, then repeat the `make` command referencing the new target.
